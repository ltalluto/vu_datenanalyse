---
title: "Worksheet 2"
author: "Matthew Talluto & Gabriel Singer"
date: "22.02.2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error=TRUE)
```

## Environmental values and environmental education

Load the environmental values dataset (Pinder et al, 2020, https://doi.org/10.5061/dryad.wdbrv15kn).

```{r}

rm(list=ls(all=TRUE))

env = read.csv("data/env_values.csv")

str(env)

```

University students in Australia were asked various questions about their environmental values, desires for conservation careers, and educational background. We will examine two variables to address the hypothesis that students from families that value the environment rate more highly the quality of their education about environmental values.

The data has two variables:

* `env_education` contains responses to the question, "Thinking back to your schooling overall, how adequate was your education about environmental problems?", ranging from 0 (extremely inadequate) to 5 (extremely adequate).
* `value_of_env_protection` has responses for, "How important is protecting the environment in your family?", ranging from 0 (not important) to 7 (very important)... note that one student indicated -1 ;-)

1. Produce a histogram for each variable and a scatterplot for both variables. How do you interpret these plots? 
```{r}
layout(matrix(1:2,nrow=1,ncol=2,byrow=TRUE)) # making room for two graphs
hist(env$env_education,freq=FALSE); lines(density(env$env_education,na.rm=TRUE))
hist(env$value_of_env_protection,freq=FALSE); lines(density(env$value_of_env_protection,na.rm=TRUE))

plot(env$env_education,env$value_of_env_protection)
plot(jitter(env$env_education),jitter(env$value_of_env_protection))

tab = table(env)
image(tab,xlab="env_education",ylab="value_of_env_protection")

# and the same a bit more complicated with enigmatic graphic package ggplot:
library(reshape2)
library(ggplot2)
pl_dat = melt(tab)
ggplot(pl_dat, aes(x = env_education, y = value_of_env_protection)) + 
	geom_raster(aes(fill = value)) + scale_fill_viridis_c()
```

Data are rank-scaled, histogram must have gaps, density (continuous distribution) not reasonable. 

2. Which type of correlation is most appropriate for these two variables?
Pearson needs continuous data, so it´s not possible to use here. Proper correlation measure is Spearman or Kendall.

3. Use the function `cor.test` on `env_education` and `value_of_env_protection`. Is there a significant correlation? What direction is it? What is the estimate of the correlation?
```{r}
cor(env$env_education,env$value_of_env_protection,use="na.or.complete",method="spearman")

cor.test(env$env_education,env$value_of_env_protection,method="spearman")

nrow(env)-sum(is.na(env$env_education) | is.na(env$value_of_env_protection)) # sample size without NAs
```
H0: Variables do not correlate.
There is a significant correlation betwen env_education and value_of_env_protection (Spearman`s rho=0.12, n=475, P<0.01).
Environmental education correlates positively (and significantly) with value of environmental protection (Spearman`s rho=0.12, n=475, P<0.01).

If H0/HA formulated one-sided (for instance, HA: positive correlation), then:

```{r}
cor.test(env$env_education,env$value_of_env_protection,method="spearman",alternative = "greater")

# alternatively just stick to default (alternative ="two.sided") and divide P by 2.
cor.test(env$env_education,env$value_of_env_protection,method="spearman")$p.value / 2
```

**Hint**: Choose the type of correlation using `method` in `cor.test`. there are missing values in the data, you will need to deal with these. 

```{r}
# Spearman correlation significance test by permutation (one-sided)
sc<-rep(NA,1000) # to collect correlation coefficients computed from permuted data
for(i in 1:1000) {
  sc[i]<-cor(cbind(sample(env$env_education),env$value_of_env_protection),
      use="pairwise.complete.obs",method="spearman")[1,2]
}
hist(sc)
sum(sc>=cor(env,use="pairwise.complete.obs",method="spearman")[1,2])/1000
```


## Hydropsyche width-mass relationship

The following dataset collects head capsule widths and body masses from Hydropsyche (a genus of caddisflies) in the Danube in Austria. Note that this data file is tab delimited, not comma delimited, so you will need `read.table`.

```{r}
hydrop = read.table("data/Hydropsyche.txt", header = TRUE)
str(hydrop)
```

1. As before, do some data exploration; plot the variables against each other, examine histograms, and possibly boxplots as well. How do you interpret these plots? Can you say anything about the relationship between these variables?
```{r}
layout(matrix(1:4,2,2,byrow=T))
hist(hydrop$width)
hist(hydrop$weight) # extremely skewed!
boxplot(scale(hydrop))
plot(weight~width,data=hydrop)

layout(1)
plot(weight~width,data=hydrop)
plot(log(weight)~log(width),data=hydrop)
```
The relationship between the two variables is positive but non-linear. Linearization is obviously possible by taking both log(x) and log(y).

2. Use `lm` to fit a simple linear model (one variable, no transformations), using body mass as the response (y) variable, and width as the predictor. Is the regression significant? Report the statistics as shown in the lecture.
```{r}
plot(weight~width,data=hydrop)
m1<-lm(weight~width,data=hydrop)
summary(m1)
abline(m1)
```

Notice obviously inadequate fit. We don´t even need diagnostic plots...

3. Produce some diagnostic plots of your model (see slide 18: Regression in R: diagnostics, or use `plot(mod)`). Is this an adequate model? Does it meet the assumptions of the linear model?
```{r}
layout(matrix(1:4,2,2))
plot(m1)
```
The diagnostic plots confirm what the Y~X plot already suggested, the linear model is not adequate. Residuals show a pattern: As we move along X (or fitted values), the residuals are first positive, then negative, then positive again.

4. Based on what you learned in 3, produce a new model, this time using a transformation of $x$ and/or $y$. Repeat 2 and 3 for the new model. Is the new model better? What does the new model imply about the relationship between mass and size? Is it testing the same hypothesis as the previous model?
```{r}
m2<-lm(log(weight)~log(width),data=hydrop)
summary(m2)
coef(m2)
plot(log(weight)~log(width),data=hydrop)
abline(m2)

plot(log(weight)~log(width),data=hydrop)
newdata <- data.frame(width=seq(min(hydrop$width),max(hydrop$width),by=0.1))
pred<-predict(mod,newdata=newdata,interval="confidence",level=0.95) 
matlines(log(newdata$width),pred)

plot(m2) # for diagnostics
```
This is a power model.
y=a*x^b  | take log
log(y)=log(a)+b*log(x)
Body mass is directly proportional to volume, volume is a power function of length. This model also makes physical sense!
Diagnostic plots are much better, indicating no trend in normally distributed residuals and no indication of variance heterogeneity.

**Bonus**: Produce a scatterplot of width (x-axis) and mass (y-axis), on the original scale with no transformations. Add the regression curve from question 3 to your plot.
```{r}
coef(m2)
plot(weight~width,data=hydrop)
x = seq(0,2,by=0.001)
yhat<-exp(coef(m2)[1]) * x^coef(m2)[2] 
lines(hydrop$width,yhat,col="red")

```


## Stoichiometry of microbes

[Hall et al. (2010)](https://www.nature.com/articles/ismej2010115) report microbial biomass stoichiometry measured on a per cell basis using Raman microspectroscopy. The experiment uses 2 species measured in 2 growth phases on 4 media differing in stoichiometry. Verucomicroba are slow-growing soil and limnic bacteria, Pectobacterium is an opportunistic fast-growing detritivore isolated from carrots. The experiment is a complete full-factorial design and the original work actually has even a fourth factor in the design (which we here ignore). There are independently replicated bottles for each cell of the design, but level of replication is a bit various. Extreme N:P media (0.5 and 500) are replicated a bit less than the intermedite N:P levels 5 and 50. In addition, in each bottle 20 specimen were actually measured under the microscope. The factor `all.treat` is a *combined* factor created by **bacterium_growth phase_medium_bottle** and codes for the independent replicates in the experimental design.

The response variables in this design are signatures extracted from Raman spectra collected from individual bacterial cells. These are proxies for specific macromolecules: 8 carbohydrates, 4 nucleic acids, 3 proteins (coded by `ca_` and `na_`, `pr_`.)

```{r}
mic = read.table("data/MicrobesStoichiometry.txt", header = TRUE)

names(mic)
```

1. The dataset is fairly large ;-), i.e. *exploration* could take you a while. Therefore start with filtering a subset of intermediate stoichiometry in the medium (either level 5 or 50).

```{r}
mic$NP<-factor(mic$NP)
mic<-subset(mic,subset=(NP==5 | NP==50) )
mic<-droplevels(mic)
```

2. The dataset is multivariate, we are mainly interested in aabundance of *nucleic acids*. Could all the nucleic acid Raman signatures be considered to inform about the same property *nucleic acid abundance*? If so, average the signatures to create a new *metavariable*. Consider using `scale` before averaging. 

```{r}
plot(mic[,grep("na",names(mic))])
# strong correlations suggest redundant information in those na-signatures
mic$na_avg<-apply(scale(mic[,grep("na",names(mic))]),1,mean)
# this is a good average na-signature, due to scaling all 4 have same weight
```

3. Measurements of individual bacterial cells are replicates **within** each bottle. The experimental design in fact requires a mixed model analysis that accounts for the dependency of measurements within each bottle. As an alternative, the dataset could be collapsed to the level it is actually independently replicated, i.e. the bottle. This could be done by computing means per bottle, forming a new dataset with only 1 *average* bacterium per bottle. It may be worthwhile to explore distribution of measurements within a bottle - maybe a different measure should be used to get an average *location*. Not collapsing the dataset to bottle means would mean to use a **pseudoreplicated** dataset.
```{r}
mic$all.treat<-droplevels(mic$all.treat) # some non-used NP levels still in here
# could check distribution within each
i<-0
i<-i+1
hist(mic$na_avg[mic$all.treat==levels(mic$all.treat)[i]])
# just rerun last two lines to get some histograms
# could also just plot all 28
layout(matrix(1:28,nrow=4,ncol=7))
par(mar=c(0,0,0,0))
for(i in 1:28) {
  hist(mic$na_avg[mic$all.treat==levels(mic$all.treat)[i]],xlab="",ylab="",main="",xaxt="n",yaxt="n",col="grey",freq=FALSE)
  lines(density(mic$na_avg[mic$all.treat==levels(mic$all.treat)[i]]))
}
# not all bottles generate ND data, maybe median is better measure for location within each bottle than mean
# now averaging data within each bottle
na_bt_med<-tapply(mic$na_avg,INDEX=mic$all.treat,median)
species<-factor(substr(names(na_bt_med),start=0,stop=3))
phase<-factor(substr(names(na_bt_med),start=5,stop=7))
mic1<-data.frame(species,phase,na_bt_med) # not used any further here

# same operation smarter with aggregate() instead
mic<-mic[,-c(2)] # aggregation will make this factor meaningless
mic2<-aggregate(.~all.treat+species+phase+NP+bottle,data=mic,FUN=median)
# compare shape and size of mic vs. mic2!
```

4. The growth rate hypothesis links stoichiometry of biomass, specifically the amount of P relative to N or C, to growth rate of organisms. Small, fast growing organisms have lower C:P and N:P ratios as higher growth means more "growth machinery" = ribosomes, that contain a lot of P. Consequently, microbial cells growing exponentially should have higher nucleic acid content. Test whether this is true for the two bacterial species and create an appropriate graph showing differences in means.
```{r}
# could do separate tests for each species, but two-way ANOVA is more efficient and could help to find an interesting interaction effect
combfac<-paste(mic2$species,mic2$phase,sep="_")
bartlett.test(mic2$na_avg~combfac)
boxplot(na_avg~species*phase,data=mic2)
# variances are still assumed as homogeneous
hist(unlist(tapply(mic2$na_avg,combfac,scale))) # quick and dirt check says ND may be given ;-)
an<-aov(na_avg~species*phase,data=mic2)
summary(an)
# interaction borderline not significant, thus in principal no post-hoc tests
TukeyHSD(an)

# making an appropriate graph
# Anova tests differences in locations=means, thus boxplots are not really appropriate
means<-tapply(mic2$na_avg,combfac,mean)
sds<-tapply(mic2$na_avg,combfac,sd)
plot(c(1:4),means,xlim=c(0.5,4.5),ylim=c(-1.5,1.5),ylab="avg nucleic acid signature", xlab="",xaxt="n",bty="l")
arrows(x0=c(1:4),y0=means-sds,y1=means+sds,angle=90,code=3)
axis(side=1,at=c(1:4),labels=names(means))
text(c(1:4),means,labels=c("a","b","a","b"),pos=4)
# obvious some things could still be improved, like using different symbols and symbol colors for the treatments  
```

Conclude: ANOVA results show significant main effects and no interaction. The interaction term is just not significant, so we should better be careful with interpreting the main effects. Also, the plot suggests quite different patterns and prompts us to rely on pairwise tests rather than the anova results. The opportunistic species has clearly higher nucleic acid content when in growth phase.

5. Assume nucleic acid abundance as indicating growth. Can both bacterial species translate increased availability of P equally well into more growth? Use the N:P levels 5 and 50 and data from the logarithmic growth phase.
```{r}
mic = read.table("data/MicrobesStoichiometry.txt", header = TRUE)
str(mic)
mic$NP<-factor(mic$NP)
mic<-subset(mic,subset=((NP==5 | NP==50) & growthphase=="log"))
mic<-droplevels(mic)
mic$na_avg<-apply(scale(mic[,grep("na",names(mic))]),1,mean)
names(mic)
mic<-mic[,-c(2)]
mic_agg<-aggregate(.~all.treat+species+growthphase+NP+bottle,data=mic,FUN=median)
mic_agg$combfac<-paste(substr(mic_agg$species,0,3),mic_agg$NP,sep="_")

table(mic_agg$combfac)

bartlett.test(na_avg~combfac,data=mic_agg)
boxplot(na_avg~species*NP,data=mic_agg)
# variances seem homogeneous
hist(unlist(tapply(mic_agg$na_avg,mic_agg$combfac,scale))) # ok
an<-aov(na_avg~species*NP,data=mic_agg)
summary(an)
# interaction significant
# thus post-hoc tests
TukeyHSD(an)

# making an appropriate graph
# Anova tests differences in locations=means, thus boxplots are not really appropriate
means<-tapply(mic_agg$na_avg,mic_agg$combfac,mean)
sds<-tapply(mic_agg$na_avg,mic_agg$combfac,sd)
plot(c(1:4),means,xlim=c(0.5,4.5),ylim=c(-1.5,1.5),ylab="avg nucleic acid signature",xlab="",xaxt="n",bty="l")
arrows(x0=c(1:4),y0=means-sds,y1=means+sds,angle=90,code=3)
axis(side=1,at=c(1:4),labels=names(means))
text(c(1:4),means,labels=c("a","b","b","b"),pos=4)
# obvious some things could still be improved, like using different symbols and symbol colors for the treatments  
```

Conclude that the opportunistic species can make better use of high-P medium.
