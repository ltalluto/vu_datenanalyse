---
title: "Worksheet 4"
author: "Gabriel Singer"
date: "16.02.2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error=TRUE)
```

## DOM from Berlin´s surface waters

Data source: Romero Gonzalez-Quijano 2022. Biogeosciences 19: 2841-2853, https://doi.org/10.5194/bg-19-2841-2022
A range of urban water bodies in Berlin´s extensive 'aquascape' were investigated for properties of dissolved organic matter (DOM). There were 4 seasonal campaigns, water bodies were classified into 2 lotic (rivers and streams) and 2 lentic (lakes and ponds) types. DOM can be considered to drive and indicate various ecosystem functions like respiration, primary production. It may also indicate pollution and react to linkage to the terrestrial surrounding. 

We will need the 'vegan' package (a lot of ordinations coded by ecologists for ecologists). Some more classical ordinations like PCA are available in the package 'MASS'.

```{r}
library(vegan)
library(MASS)

DOM<-read.table(file="data/DOM_Berlin_Romero.txt",header=TRUE)
names(DOM)
```

The dataset includes DOC indicating pure quantity and several descriptors of DOM quality measured by optical instruments (SR:fresh,C1:C6), chromatography (HMWS.C:humic.N) and mass spectrometry (avgmolmass:O_C) (see the Excel sheet or the original paper for detailed variable description). Mass-spectrometric information only exist for three seasons. The dataset also includes variables that should be considered as drivers of DOM composition: nutrient concentrations, Chlorophyll-a, landuse percentages (NH4:URG).

1. DOM consists of thousands of chemical structures. We try to understand its 'composition' by throwing analytics on it to produce many at least partially collinear descriptors. Reduce the dimensionality of the DOM dataset to a meaningful number of dimensions by PCA. Leave away incomplete mass-spectrometric information. How much variance do individual PC-axes explain? How many axes do you need to properly represent the dataset? Note that the latter question may be answered based on PCA-results or based on theoretical considerations considering the study design of 4 water body types sampled across 4 seasons.

```{r}
lipids$temperature = factor(lipids$temperature)
subset()
t.test()
```

2. Create a biplot for PC1 and PC2 with the most important variables defining these two axes. Plot the various water bodies and code symbol shape and symbol color to represent the study design targetting 4 water body types and 4 seasons. Note that sites and variables (or subsets thereof) do not have to be plotted onto a single biplot.

```{r}
lipids_warm = lipids[lipids$isolate == 'warm',]
# several "homemade" TSs possible: difference of rank sums between samples, difference of sample means, difference of sample means weighted by variance, just the formula of the t-statistic anyway. 
# ranks(x) # to get ranks of a vector if such a transformation is desired
# sample(x) # creates a random permutation of x

# schematically (!!) your code will have to look this:
TS_p<-numeric(999) # a vector to collect TS computed after permutation
for (i in 1:999) {
	temp_p = sample(temperature) # random assignment of temp to objects
	x1 = x[lipids_warm$temperature == "6"] # values of response x for first temp treatment
	x2 =  # same for second temp treatment
	TS_p[i] = # computing your TS
}
## null distribution of TSs
hist(TS_p)

# assess how likely your "empirical" TS is given this null distribution
# the "empirical" one is the TS computed for the unpermuted data!
abline(v = TS_emp, col='red', lwd=2)

##  how likely is a value as or more extreme than the observed if the null is true
## absolute values make this a two-sided test
hist(abs(TS_p))
abline(v = abs(TS_emp), col='red', lwd=2)

## compute a p-value
sum(abs(TS_p) >= abs(TS_emp)) / 1000

## if we want to do a one-sided test
sum(TS_p <= TS_emp) / 1000 # change >/< depending on hypothesis

```

3. Assess differences between water body types with respect to average composition of DOM and with respect to sesonal turnover of DOM composition. This question translates to an assessment of location and of seasonal variation along PC1 and PC2. You may add univariate formal hypothesis tests using the PCs as response metavariables. Use various graphical means for plotting of the sites to illustrate.

```{r}
library(vegan)
subset() # choose only FA columns
dmat = vegdist(data, method = "bray") # compute a dissimilarity matrix

clu_1<-hclust(dmat, method = "single") # one of many possible solutions, play with setting for method, check help(hclust)

plot(clu_1)

cor(dmat, cophenetic(clu_1), method = "spearman")

plot(dmat, cophenetic(clu_1))

```

Which water bodies differ markedly among each other in DOM? Which water bodies show more seasonal DOM turnover?

4. Adding incomplete descriptors

```{r}
pcoa = cmdscale(dmat, k = 2, eig=TRUE) # always computes all axes, but will only report scores of k=2
pcoa$eig # to assess importance of axes

plot(pcoa$points) # score plot
# but use isolate and temperature information to color and set point characters

pch.temperature <- as.integer(as.character(lipids$temperature))
pch.temperature[pch.temperature==6]<-21
pch.temperature[pch.temperature==28]<-23

library(RColorBrewer)
cols = brewer.pal(8, "Set2")
col.isolate = lipids$isolate
col.isolate[col.isolate == "warm"] = cols[1]
col.isolate[col.isolate == "cold"] = cols[2]

# to show variables
plot(envfit())
ordisurf() # as contourplot

```

**Bonus**: Compare PCoA results with results of a PCA on the raw data.

5. Assess potential drivers

```{r}
mds_lipids = metaMDS(comm = , distance = "bray", k = 2, trymax = 100) # to run a NMDS, $points to get scores, $stress to get information about fit
mds_lipids$stress
## % of dissimilarities unrepresented

stressplot() # to compare configuration distances with dissimilarities
goodness() # sample-specific goodness of fit

plot(mds_lipids$points,asp=1)
# will need better colors and pch settings again

# to define space using the variables
wascores(configuration,data) # variables as weighted averages of site (=sample) scores
ordisurf() # as contourplot
envfit() # take care: behaviour of variables not necessarily monotonous in ordination space

# some more useful graphical tools
ordispider() # you will want 1 factor with 4 levels here
ordihull()
ordiellipse()
ordicluster()
```

6. The results clearly suggest differences in fatty acid composition due to isolate and temperature. Specify hypotheses for these two main effects and a potential interaction. Test using PERMANOVA. Just like in ANOVA, where variance homogeneity is of interest, here we should check multivariate variance (*cloud shape*) known as *dispersion*.

##############################################

```{r}
bd<-betadisper() # to test dispersion, works only with one factor
anova(bd) # test for dispersion differences
adonis() # PERMANOVA, just use like aov() or lm()
```
